{% extends "api_auto/base.html" %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5>接口管理</h5>
        <a href="{% url 'api_auto:api_management_add' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> 新增接口
        </a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>测试用例编号</th>
                        <th>测试用例名称</th>
                        <th>接口名称</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for case in cases %}
                    <tr>
                                <td>{{ case.case_id }}</td>
                                <td>
                                    {% if case.case_info %}
                                        {{ case.case_info.case_name }}
                                    {% else %}
                                        <span class="text-muted">未关联用例信息</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if case.api %}
                                        {{ case.api.api_name }}
                                    {% else %}
                                        <span class="text-muted">未关联接口</span>
                                    {% endif %}
                                </td>
                        <td class="d-flex gap-2">
                            <a href="{% url 'api_auto:api_management_edit' case.case_step_info_id %}"
                               class="btn btn-primary text-white px-3 py-1">
                                <i class="bi bi-pencil me-1"></i>编辑
                            </a>
                            <button type="button" class="btn btn-primary text-white px-3 py-1 run-single"
                                    data-case-id="{{ case.case_step_info_id }}">
                                <i class="bi bi-play me-1"></i>执行
                            </button>
                            <form method="post" action="{% url 'api_auto:api_management_delete' case.case_step_info_id %}"
                                  style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary text-white px-3 py-1"
                                        onclick="return confirm('确定删除此接口管理记录吗？')">
                                    <i class="bi bi-trash me-1"></i>删除
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">暂无接口管理记录</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 单条用例执行
document.querySelectorAll('.run-single').forEach(btn => {
    btn.addEventListener('click', function() {
        const caseId = this.getAttribute('data-case-id');
        const btnIcon = this.querySelector('i');
        const originalClass = btnIcon.className;

        // 显示加载状态
        btnIcon.className = 'spinner-border spinner-border-sm';
        this.disabled = true;

        fetch(`{% url 'api_auto:run_single_case' '0' %}`.replace('0', caseId), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 执行成功，刷新页面
                location.reload();
            } else {
                alert('执行失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('请求失败: ' + error);
        })
        .finally(() => {
            // 恢复按钮状态
            btnIcon.className = originalClass;
            this.disabled = false;
        });
    });
});
</script>
{% endblock %}