{% extends "api_auto/base.html" %}

{% block title %}用例列表 - 接口自动化平台{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- 消息提示 -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- 操作栏 -->
    <div class="card mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
            <h5 class="mb-0">用例列表（共{{ paginator.count }}条）</h5>
            <div>
                <a href="{% url 'api_auto:import_excel' %}" class="btn btn-primary btn-sm me-2">
                    <i class="bi bi-upload me-1"></i>导入Excel
                </a>
                <button id="runAllBtn" class="btn btn-success btn-sm me-2" onclick="runAllCases()">
                    <span id="runAllText">执行所有用例</span>
                    <span id="runAllSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- 用例表格 -->
    <form id="caseForm" method="post" action="{% url 'api_auto:case_list' %}">
        {% csrf_token %}
        <input type="hidden" name="batch_run" value="1">
        <div class="card">
            <div class="card-body overflow-x-auto">
                <table class="table table-hover table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50px;"><input type="checkbox" id="selectAll"></th>
                            <th>模块名称</th>
                            <th>测试用例编号</th>
                            <th>接口名称</th>
                            <th>请求方式</th>
                            <th>请求地址</th>
                            <th>是否通过</th>
                            <th style="width: 120px;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for case in cases %}
                            <tr>
                                <td><input type="checkbox" name="case_ids" value="{{ case.case_step_info_id }}"></td>
                                <td>{{ case.part_name }}</td>
                                <td>{{ case.case_id }}</td>
                                <td>{{ case.api.api_name }}</td>
                                <td>{{ case.api.api_request_type }}</td>
                                <td>{{ case.api.api_request_url }}</td>
                                <td>
                                    {% if case.is_pass == "通过" %}
                                        <span class="text-success fw-bold">{{ case.is_pass }}</span>
                                    {% elif case.is_pass == "失败" %}
                                        <span class="text-danger fw-bold">{{ case.is_pass }}</span>
                                    {% else %}
                                        <span class="text-secondary">未执行</span>
                                    {% endif %}
                                </td>
                                <td class="d-flex">
                                    <a href="{% url 'api_auto:case_detail' case.case_step_info_id %}"
                                       class="btn btn-info btn-sm me-2">详情</a>
                                    <button type="button" class="btn btn-success btn-sm run-single"
                                            data-case-id="{{ case.case_step_info_id }}">执行</button>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="8" class="text-center">暂无测试用例数据</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- 分页导航 -->
            <div class="card-footer d-flex justify-content-between align-items-center">
                <div class="text-muted">
                    显示第 {{ cases.number }} 页，共 {{ paginator.num_pages }} 页
                </div>
                <nav aria-label="Page navigation">
                    <ul class="pagination pagination-sm mb-0">
                        {% if cases.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1">首页</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ cases.previous_page_number }}">上一页</a>
                            </li>
                        {% endif %}

                        {% for page_num in cases.paginator.page_range %}
                            {% if page_num > cases.number|add:-3 and page_num < cases.number|add:3 %}
                                <li class="page-item {% if page_num == cases.number %}active{% endif %}">
                                    <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if cases.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ cases.next_page_number }}">下一页</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ paginator.num_pages }}">末页</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    </form>
</div>

<!-- 执行结果模态框 -->
<div class="modal fade" id="runResultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">用例执行结果</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="runResultContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// 全选/取消全选
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('input[name="case_ids"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
});

// 执行所有用例
function runAllCases() {
    const btn = document.getElementById('runAllBtn');
    const text = document.getElementById('runAllText');
    const spinner = document.getElementById('runAllSpinner');

    btn.disabled = true;
    text.textContent = '执行中...';
    spinner.classList.remove('d-none');

    fetch("{% url 'api_auto:run_all_cases' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    }).then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        }
    });
}

// 单条用例执行
document.querySelectorAll('.run-single').forEach(btn => {
    btn.addEventListener('click', function() {
        const caseId = this.getAttribute('data-case-id');
        const btnText = this.innerHTML;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 执行中...';
        this.disabled = true;

        fetch(`{% url 'api_auto:run_single_case' '0' %}`.replace('0', caseId))
            .then(response => response.json())
            .then(data => {
                const modalContent = document.getElementById('runResultContent');
                if (data.status === 'success') {
                    modalContent.innerHTML = `
                        <div class="alert alert-success">
                            ${data.message}
                        </div>
                    `;
                    setTimeout(() => location.reload(), 1500);
                } else {
                    modalContent.innerHTML = `
                        <div class="alert alert-danger">
                            ${data.message}
                        </div>
                    `;
                }
                new bootstrap.Modal('#runResultModal').show();
            })
            .finally(() => {
                this.innerHTML = btnText;
                this.disabled = false;
            });
    });
});
</script>
{% endblock %}